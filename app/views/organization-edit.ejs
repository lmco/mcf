<%
const projects = org.projects;
const members = org.permissions.read;
%>

<div class="container mbee-organization">

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/organizations">Organizations</a></li>
      <li class="breadcrumb-item"><a href="/<%= org.id %>"><%= org.name %></a></li>
      <li class="breadcrumb-item active" aria-current="page">edit</li>
    </ol>
  </nav>
  <hr class="mb-4">
  <div class="org-header">
    <h1 class="display-4"><%= org.name%></h1>
  </div>

  <form>
    <div class="form-group">
      <label for="name">Organization Name</label>
      <input class="form-control" id="name" aria-describedby="emailHelp" placeholder="Organization Name" value="<%= org.name %>">
    </div>
    <div class="form-group">
      <label for="custom">Custom Data</label>
      <textarea class="form-control" id="custom" rows="10" placeholder="Custom Data"><%= JSON.stringify(org.custom, null, 2) %></textarea>
    </div>
    <button id="subitForm" type="button" class="btn btn-primary">Save</button>
  </form>
</div>

<div id="status-modal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 id="modal-title" class="modal-title" style="color: #222222;">Success!</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="modal-message" style="color:#333;">Your updates to <%= org.name%> were saved successfully.</p>
      </div>
      <div class="modal-footer">
        <a id="modal-button" href="">OK</a>
      </div>
    </div>
  </div>
</div>

<%- contentFor('scripts') %>
<script>
  $(document).ready(function() {
    $('#subitForm').click(function() {
      try {
        JSON.parse($("#custom").val())
      }
      catch {
        $('#custom').effect('shake')
        return
      }
      jQuery.ajax({
        method: "PATCH",
        url: "<%= `/api/orgs/${org.id}` %>",
        data: {name: $("#name").val(), custom: JSON.parse($("#custom").val())}
      })
      .done(function (msg, status) {
        $('#modal-title').html('Success!');
        $('#modal-message').html('Your updates to <%= org.name%> were saved successfully.');
        $('#status-modal').modal('show');
        $('#modal-button').removeAttr('data-dismiss')
        $('#modal-button').removeAttr('aria-label')
        $('#modal-button').attr('href', '<%= `/${org.id}` %>');
        $('#modal-button').attr('class', 'btn btn-success');
      })
      .fail(function(msg) {
        console.log(msg)
        $('#modal-button').attr('class', 'btn btn-warning');
        $('#modal-button').attr('data-dismiss', 'modal');
        $('#modal-button').attr('aria-label', 'Close');
        $('#modal-button').removeAttr('href')
        if (msg.status === 400){
          $('#modal-title').html('Failed!');
          $('#modal-message').html('Your updates to <%= org.name %> could not be saved. Please ensure you are using a valid name and the custom field contains valid JSON.');
        }
        else {
          $('#modal-title').html('Failed!');
          $('#modal-message').html('Your updates to <%= org.name %> could not be saved.');
        }
        $('#status-modal').modal('show');
      })
    });
  });
</script>
